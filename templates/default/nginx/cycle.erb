server {
  listen 80;
  server_name <%= node[:hostname] %>;

  access_log <%= node[:nginx][:log_dir] %>/<%= node[:hostname] %>.access.log;

  root <%= node[:apps][:cycle][:path] %>/<%= node[:apps][:cycle][:relative_docroot] %>;
  index index.php;

  location = / {
    try_files @site @site;
  }

  location / {
    try_files $uri $uri/ @site;
  }

  location ~ \.php$ {
    return 404;
  }

  location @site {
    fastcgi_pass unix:/var/run/php-fpm-www.sock;
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root/index.php;
    <% node[:apps][:cycle][:environment].each do |environment_name, environment_value| %>
      fastcgi_param <%= environment_name %> <%= environment_value %>;
    <% end %>
  }
}
